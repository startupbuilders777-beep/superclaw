name: Close Asana Task on Merge

on:
  pull_request:
    types: [closed]

jobs:
  close-asana-task:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Extract Asana GID and close task
        env:
          ASANA_TOKEN: ${{ secrets.ASANA_TOKEN }}
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body }}"

          # Extract ASANA-<GID> from title or body
          GID=$(echo "$PR_TITLE $PR_BODY" | grep -oP 'ASANA-[0-9]+' | head -1 | sed 's/ASANA-//')

          if [ -z "$GID" ]; then
            echo "No Asana GID found in PR title or body. Skipping."
            exit 0
          fi

          echo "Found Asana task GID: $GID"

          # Mark task as complete
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X PUT \
            -H "Authorization: Bearer $ASANA_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"data":{"completed":true}}' \
            "https://app.asana.com/api/1.0/tasks/$GID")

          if [ "$HTTP_CODE" = "200" ]; then
            echo "Asana task $GID marked complete"
          else
            echo "Failed to close Asana task $GID (HTTP $HTTP_CODE)"
            exit 1
          fi

          # Add comment to task
          curl -s -X POST \
            -H "Authorization: Bearer $ASANA_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"data\":{\"text\":\"Auto-closed by GitHub Actions. PR #${{ github.event.pull_request.number }} merged to main.\"}}" \
            "https://app.asana.com/api/1.0/tasks/$GID/stories" > /dev/null

          echo "Added merge comment to Asana task"
